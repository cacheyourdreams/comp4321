<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content=""><!-- 
    <link rel="icon" href="../../favicon.ico"> -->

    <title>Asynchronous Realtime Search Engine</title>

    <!-- Bootstrap core CSS -->
    <link href="dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="grid.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="assets/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script src="http://code.jquery.com/jquery-2.0.3.js"></script>
    <script>

    $(function() {

      // handle query submission
      $("#query-submit").click(function(e) {

        e.preventDefault();

        var query = $("#query").val();
        
        $.ajax({
            type : 'POST',
            url : 'script.py',
            data : {'query': query}
        }).done(function(response) {
          
          // parse the resulting string
          var list = $.parseJSON(response);

          $(".page-header").hide();

          // loop over elements in the array
          for (i in list) {

            if (i == 0) {

              var t = $.parseJSON(list[i].result);
              if (t.hasOwnProperty('error')) {
                $(".alert-danger").html(t.error);
                $(".alert-danger").show();
                $(".alert-success").hide();
                $(".list-group").hide();
                return;
              }

              var json = $.parseJSON(list[i].result);
              var txt = "<strong>Time Taken: "+json.time_taken+"</strong>";
              txt += " Total results: "+json.total_results;
              $(".alert-success").html(txt);
              $(".alert-danger").hide();
              $(".alert-success").show();
              $(".list-group").show();

              continue;
            }

            // parse json object in array
            var json = $.parseJSON(list[i].result);
            $(".list-group").append(parseResultListELement(json));
          }
          
        });
      });

      function getResultsTotalContainer(total) {
        return '<button type="button" class="btn btn-success">Total Results:' + total + '</button>';
      }

      function getResultsTimeContainer(time) {
      return '<button type="button" class="btn btn-info">Time Elapsed: ' +  time + '</button>';
      }


      $('body').on('click', '#list-toggle', function(e){
          e.preventDefault();
          if (!$(this).attr('data-toggled') || $(this).attr('data-toggled') == 'off'){
            switch($(this).attr('class')) {
              case "parent":
                $(this).parent().children("#parent-list").show();
                break;
              case "child":
              $(this).parent().children("#child-list").show();
                break;
            }
            $(this).attr('data-toggled','on');
          }
          else if ($(this).attr('data-toggled') == 'on'){
            switch($(this).attr('class')) {
              case "parent":
                $(this).parent().children("#parent-list").hide();
                break;
              case "child":
              $(this).parent().children("#child-list").hide();
                break;
            }
            $(this).attr('data-toggled','off');
                 
          }
      });


    });

    function parseResultListELement(json) {

      console.log(json);

      var el = "";



      el += '<div class="list-group-item">';

      el += '<h4 class="list-group-item-heading">';
      el += '<a href="' + json.url + '">';
      el += json.title;
      el += "</a>";
      el += '</h4>'

      el += '<p class="list-group-item-text">';
      el += '<strong >Score: </strong>';
      el += json.rank;
      el += '</p>';

      el += '<p class="list-group-item-text">';
      el += "<strong>Url: </strong>";
      el += '<a href="' + json.url + '">';
      el += json.url;
      el += "</a>";
      el += '</p>'

      el += '<p class="list-group-item-text">';
      el += '<b>Last Modified:</b> ' + json.modified;
      el += '&nbsp; <b>Page Size:</b> ' + json.size
      el += '</p>'

      el += '<p class="list-group-item-text">';
      el += "<b>Keywords:</b> &nbsp";
      for (keyword in json.keywords) {
        el += keyword + ", freq: " + json.keywords[keyword] + "; &nbsp;";
      }
      el += '</p>'

      el += '<a id="list-toggle" class="parent" href="#">Parent pages</a>';
      el += '<ul id="parent-list" style="display:none">';
      for (parent in json.parents) {
        el += "<li>";
        el += json.parents[parent];
        el += "</li>"
      }
      el += "</ul>";

      el += "&nbsp";

      el += '<a id="list-toggle" class="child" href="#">Child pages</a>';
      el += '<ul id="child-list" style="display:none">';
      for (child in json.children) {
        el += "<li>";
        el += json.children[child];
        el += "</li>"
      }
      el += "</ul>";


      el += '</div>';
      return el;
    }


    </script>

  </head>

  <body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
        </div>
      </div>
    </nav>
    <div class="container">


      <div class="page-header">
        <h1>Asynchronous Realtime Search Engine</h1>
        <p class="lead">By Malcom Macgregor, Olly Styles, and Nicholas Jarzembowski.</p>
      </div>

      <form id="query-form" style="margin-top:2.5%">
      <div class="input-group">
      <span class="input-group-addon" id="basic-addon1">
         <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
      </span>
        <input id="query" type="text" class="form-control" id="search-query" placeholder="Search for...">
        <span class="input-group-btn">
          <button id="query-submit" class="btn btn-default" type="button">Go!</button>
        </span>
      </div><!-- /input-group -->
      </form>

      <br />

      <div class="alerts-group">
        <div style="display:none" class="alert alert-success" role="alert">
        </div>
        <div style="display:none" class="alert alert-danger" role="alert">
        </div>
      </div>

      <div class="list-group">
        <!-- contains search results -->
      </div>

<!--       <h3>Three equal columns</h3>
      <p>Get three equal-width columns <strong>starting at desktops and scaling to large desktops</strong>. On mobile devices, tablets and below, the columns will automatically stack.</p>
      <div class="row">
        <div class="col-md-4">.col-md-4</div>
        <div class="col-md-4">.col-md-4</div>
        <div class="col-md-4">.col-md-4</div>
      </div> -->


    </div> <!-- /container -->


    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="assets/js/ie10-viewport-bug-workaround.js"></script>
  </body>
</html>
